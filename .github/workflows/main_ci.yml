# .github/workflows/main_ci.yml

#Déclenchement sur chaque push ou pull resquest sur la branche 'develop'
on:
  push:
    branches: [ develop, main ]
  
  pull_request:
    branches: [ develop, main ]

jobs:
  build-test-and-deploy:
    #Exécuter la dernière version de ubuntu
    runs-on: ubuntu-latest

    #Cycle CI/CD
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Installer les dépendances
          pip install -r requirements.txt

      #EXECUTION DES TESTS
      - name: Run pytest and generate coverage Report
        run: |
          #Pytest exécute tous les test unitaires et fonctionnels
          #--cov=src: Calcule la couverture du dossier src/ sur les tests
          #--vov-report=xml: Va générer le rapport XL nécessaire à l'intégration continue
          pytest --cov=src --cov-report=xml
      

      #Phase de déploiement
      #Configurer l'environnement
      - name: Configure Git
        run: |
          git config --global user.email "bazaroph@gmail.com"
          git config --global user.name "GitHub Actions"
      - name: Deploy to Hugging Face Spaces
        if: github.ref == 'refs/heads/main'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          it config --global user.email "bazaroph@gmail.com"
          git config --global user.name "GitHub Actions"
          echo "Déploiement en production sur Hugging Face Spaces..."
          git add .
          git commit -m "Déploiement automatique depuis GitHub Actions" || echo "Aucun changement à committer"
          git push https://$HF_TOKEN@huggingface.co/$HF_USERNAME/$HF_SPACE_NAME main

      
